name: Run Phase 1 Calls (v4)
on:
  workflow_dispatch:

jobs:
  run-scenarios:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Version marker
        run: echo "CI v4 $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      # Use curl fallback to avoid any toolchain action hiccups
      - name: Install Foundry (curl)
        run: |
          set -euxo pipefail
          curl -L https://foundry.paradigm.xyz | bash
          echo "$HOME/.foundry/bin" >> $GITHUB_PATH
          $HOME/.foundry/bin/foundryup
          forge --version
          cast --version

      # If forge-std isn't checked in, this installs it in CI (with debug output)
      - name: Ensure forge-std (install + debug)
        run: |
          set -euxo pipefail
          echo "Working dir: $(pwd)"
          git rev-parse --abbrev-ref HEAD || true
          ls -la
          # Install if missing (do not use --no-commit so remappings.txt can be written)
          if [ ! -d lib/forge-std ]; then
            echo "forge-std not found in repo; installingâ€¦"
            forge install foundry-rs/forge-std
          else
            echo "forge-std present in repo"
          fi
          echo "foundry.toml content:"
          cat foundry.toml || true
          echo "remappings.txt (if present):"
          cat remappings.txt || true
          echo "forge remappings output:"
          forge remappings || true
          echo "List lib/forge-std/src:"
          ls -la lib/forge-std/src || true
          # sanity check the Script.sol file exists
          test -f lib/forge-std/src/Script.sol

      - name: Build contracts
        run: forge build --sizes -vvv

      - name: Run tests
        run: forge test -vvv

      - name: Dump workspace on failure
        if: failure()
        run: |
          set -euxo pipefail
          echo "=== Workspace ==="
          pwd
          ls -la
          echo "=== lib dir ==="
          ls -la lib || true
          echo "=== remappings.txt ==="
          cat remappings.txt || true
          echo "=== foundry.toml ==="
          cat foundry.toml || true

      # --- Optional: only if your script exists and you set secrets ---
      - name: Make scenario script executable
        if: ${{ hashFiles('scripts/run_phase1_calls.sh') != '' }}
        run: chmod +x scripts/run_phase1_calls.sh

      - name: Run Phase 1 scenarios
        if: ${{ hashFiles('scripts/run_phase1_calls.sh') != '' }}
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          RPC_URL: ${{ secrets.RPC_URL }}
          CONTRACT_ADDRESS: ${{ secrets.CONTRACT_ADDRESS }}
        run: |
          set -euo pipefail
          : "${PRIVATE_KEY:?Missing PRIVATE_KEY secret}"
          : "${RPC_URL:?Missing RPC_URL secret}"
          : "${CONTRACT_ADDRESS:?Missing CONTRACT_ADDRESS secret}"
          ./scripts/run_phase1_calls.sh

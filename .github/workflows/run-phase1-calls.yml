name: Run Phase 1 Calls (v4)
on:
  workflow_dispatch:

jobs:
  run-scenarios:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Version marker
        run: echo "CI v4 $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      # Use curl fallback to avoid any toolchain action hiccups
      - name: Install Foundry (curl)
        run: |
          set -euxo pipefail
          curl -L https://foundry.paradigm.xyz | bash
          echo "$HOME/.foundry/bin" >> $GITHUB_PATH
          $HOME/.foundry/bin/foundryup
          forge --version
          cast --version

      # If forge-std isn't checked in, this installs it in CI
      - name: Ensure forge-std
        run: |
          set -euxo pipefail
          if [ ! -d lib/forge-std ]; then
            echo "forge-std not found in repo; installingâ€¦"
            forge install --no-commit foundry-rs/forge-std
          else
            echo "forge-std present in repo"
          fi
          ls -la lib || true
          test -f lib/forge-std/src/Script.sol

      - name: Build contracts
        run: forge build --sizes

      - name: Run tests
        run: forge test -vvv

      # --- Optional: only if your script exists and you set secrets ---
      - name: Make scenario script executable
        if: ${{ hashFiles('scripts/run_phase1_calls.sh') != '' }}
        run: chmod +x scripts/run_phase1_calls.sh

      - name: Run Phase 1 scenarios
        if: ${{ hashFiles('scripts/run_phase1_calls.sh') != '' }}
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          RPC_URL: ${{ secrets.RPC_URL }}
          CONTRACT_ADDRESS: ${{ secrets.CONTRACT_ADDRESS }}
        run: |
          set -euo pipefail
          : "${PRIVATE_KEY:?Missing PRIVATE_KEY secret}"
          : "${RPC_URL:?Missing RPC_URL secret}"
          : "${CONTRACT_ADDRESS:?Missing CONTRACT_ADDRESS secret}"
          ./scripts/run_phase1_calls.sh

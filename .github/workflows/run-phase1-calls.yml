name: Run Phase 1 Calls
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours (UTC)

jobs:
  run-scenarios:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show repo layout (debug)
        run: |
          set -euxo pipefail
          pwd
          ls -la
          test -f foundry.toml

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Verify Foundry install
        run: |
          set -euxo pipefail
          forge --version
          cast --version

      # If forge-std isn't checked in, this will fetch it
      - name: Ensure forge-std (if not checked in)
        run: |
          set -euxo pipefail
          if [ ! -d lib/forge-std ]; then
            forge install --no-commit foundry-rs/forge-std
          fi

      - name: Build contracts
        run: |
          set -euxo pipefail
          forge build --sizes

      - name: Run tests
        run: |
          set -euxo pipefail
          forge test -vvv

      # ----- Optional scenario script -----
      - name: Make scenario script executable
        if: ${{ hashFiles('scripts/run_phase1_calls.sh') != '' }}
        run: chmod +x scripts/run_phase1_calls.sh

      - name: Run Phase 1 scenarios
        if: ${{ hashFiles('scripts/run_phase1_calls.sh') != '' }}
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          RPC_URL: ${{ secrets.RPC_URL }}
          CONTRACT_ADDRESS: ${{ secrets.CONTRACT_ADDRESS }}
        run: |
          set -euo pipefail
          # explicit secret checks (no secrets in if:)
          if [ -z "${PRIVATE_KEY:-}" ]; then echo "Missing PRIVATE_KEY secret"; exit 1; fi
          if [ -z "${RPC_URL:-}" ]; then echo "Missing RPC_URL secret"; exit 1; fi
          if [ -z "${CONTRACT_ADDRESS:-}" ]; then echo "Missing CONTRACT_ADDRESS secret"; exit 1; fi
          ./scripts/run_phase1_calls.sh
